# Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø±Ùˆ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø¨Ø²Ù† ØªØ§ TelethonØŒ librosaØŒ spotipy Ùˆ flask Ù†ØµØ¨ Ø´Ù‡:
# pip install telethon librosa numpy spotipy flask

from telethon import TelegramClient
import os
import re
import librosa
import numpy as np
import spotipy
from spotipy.oauth2 import SpotifyClientCredentials
import json
from flask import Flask, jsonify, send_from_directory, render_template_string

# --------- Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙ†Ø¸ÛŒÙ…Ø§Øª API ØªÙ„Ú¯Ø±Ø§Ù… ---------
api_id = '26973577'
api_hash = 'bf3596c4fbf3689f2df5d6c2c2428a4a'
channel_username = 'RadioRockie'

# --------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª API Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ---------
sp = spotipy.Spotify(auth_manager=SpotifyClientCredentials(
    client_id='YOUR_SPOTIFY_CLIENT_ID',
    client_secret='YOUR_SPOTIFY_CLIENT_SECRET'
))

# Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
save_path = 'downloaded_music'
os.makedirs(save_path, exist_ok=True)

# ØªØ§Ø¨Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² Ø¯Ø± Ù†Ø§Ù… ÙØ§ÛŒÙ„
def clean_filename(filename):
    return re.sub(r'[<>:"/\\|?*]', '', filename)

# ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ…Ù¾Ùˆ Ùˆ Ø§Ù†Ø±Ú˜ÛŒ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ
def analyze_audio(file_path):
    y, sr = librosa.load(file_path)
    tempo, _ = librosa.beat.beat_track(y=y, sr=sr)
    energy = np.mean(y ** 2)
    return tempo, energy

# ØªØ§Ø¨Ø¹ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªØ±Ú© Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ùˆ Ú¯Ø±ÙØªÙ† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¢Ù†
def get_spotify_info(track_name):
    results = sp.search(q=track_name, type='track', limit=1)
    if results['tracks']['items']:
        track = results['tracks']['items'][0]
        track_id = track['id']
        audio_features = sp.audio_features(track_id)[0]
        return {
            'tempo': audio_features['tempo'],
            'energy': audio_features['energy'],
            'danceability': audio_features['danceability'],
            'crossfade_recommendation': round(max(1, min(10, (audio_features['tempo'] / 20) + (audio_features['danceability'] * 5))))
        }
    return None

# --------- Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ---------
client = TelegramClient('music_downloader_session', api_id, api_hash)

async def download_music():
    await client.start()
    report = []
    async for msg in client.iter_messages(channel_username):
        if msg.file and msg.file.mime_type and 'audio' in msg.file.mime_type:
            file_name = msg.file.name or f'{msg.id}.mp3'
            file_name = clean_filename(file_name)
            full_path = os.path.join(save_path, file_name)
            print(f'Downloading: {file_name}')
            await msg.download_media(file=full_path)

            local_tempo, local_energy = analyze_audio(full_path)
            spotify_info = get_spotify_info(file_name.replace('.mp3', ''))

            track_data = {
                'file_name': file_name,
                'local_tempo': local_tempo,
                'local_energy': local_energy,
                'spotify_info': spotify_info or {}
            }

            if spotify_info:
                print(f'âœ” {file_name} | Local Tempo: {local_tempo:.2f} BPM | Spotify Tempo: {spotify_info["tempo"]} BPM | Energy: {spotify_info["energy"]:.2f} | Danceability: {spotify_info["danceability"]:.2f} | Suggested crossfade: {spotify_info["crossfade_recommendation"]}s')
            else:
                print(f'âœ” {file_name} | Local Tempo: {local_tempo:.2f} BPM | Energy: {local_energy:.4f} | No Spotify data found')

            report.append(track_data)

    with open('music_analysis_report.json', 'w') as f:
        json.dump(report, f, indent=4)

    print('âœ… All music files downloaded, analyzed, and report saved.')

# --------- Ø³Ø±ÙˆØ± ÙÙ„ÙØ³Ú© Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø§Ø³ØªØ±ÛŒÙ… Ù…ÙˆØ²ÛŒÚ©â€ŒÙ‡Ø§ ---------
app = Flask(__name__)

@app.route('/')
def index():
    with open('music_analysis_report.json', 'r') as f:
        tracks = json.load(f)

    html = """
    <html><head><title>My DJ Station ğŸ§</title></head><body>
    <h1>ğŸµ Music List</h1>
    <p>Best VPS recommendation: Buy a Linux VPS with at least 2 CPU cores, 4GB RAM, 40GB SSD, Ubuntu 22.04 or Debian 12 installed. Providers like Hetzner, Contabo, or Vultr are great for price/performance.</p>
    {% for track in tracks %}
    <div style='margin-bottom:30px;'>
        <h3>{{ track.file_name }}</h3>
        <p>Local Tempo: {{ track.local_tempo }} BPM</p>
        <p>Energy: {{ track.local_energy }}</p>
        {% if track.spotify_info %}
            <p>Spotify Tempo: {{ track.spotify_info.tempo }} | Energy: {{ track.spotify_info.energy }} | Danceability: {{ track.spotify_info.danceability }}</p>
            <p>Suggested Crossfade: {{ track.spotify_info.crossfade_recommendation }} seconds</p>
        {% endif %}
        <audio controls>
            <source src="/stream/{{ track.file_name }}" type="audio/mpeg">
        </audio>
    </div>
    {% endfor %}
    </body></html>
    """
    return render_template_string(html, tracks=tracks)

@app.route('/stream/<filename>')
def stream(filename):
    return send_from_directory(save_path, filename)

if __name__ == "__main__":
    import asyncio
    import threading

    def start_download():
        asyncio.run(download_music())

    threading.Thread(target=start_download).start()

    app.run(debug=True, port=5000)
